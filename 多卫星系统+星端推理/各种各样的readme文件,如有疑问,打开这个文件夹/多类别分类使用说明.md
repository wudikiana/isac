# 多类别分类功能使用说明

## 概述

本项目实现了多样化的掩码处理和多类别分类功能，让模型能够学习不同损坏级别的掩码含义。

### 掩码含义

- **0**: 背景
- **1**: 未损坏
- **2**: 轻微损坏
- **3**: 中等损坏
- **4**: 严重损坏

## 多样化的掩码处理

### 支持的damage_level参数

1. **'all'** (默认)
   - 所有损坏级别(2,3,4)都标记为1
   - 适用于二分类任务

2. **'light'**
   - 轻微损坏(2)标记为0.3
   - 中等损坏(3)标记为0.6
   - 严重损坏(4)标记为1.0
   - 适用于渐进式学习

3. **'binary'**
   - 轻微损坏(2)标记为0
   - 中等和严重损坏(3,4)标记为1
   - 适用于只关注严重损坏的任务

4. **'multi'**
   - 轻微损坏(2)标记为1
   - 中等损坏(3)标记为2
   - 严重损坏(4)标记为3
   - 适用于多级分类

5. **'progressive'**
   - 轻微损坏(2)标记为0.25
   - 中等损坏(3)标记为0.5
   - 严重损坏(4)标记为1.0
   - 适用于渐进式权重学习

6. **'categorical'** (推荐用于多类别分类)
   - 背景(0)标记为0
   - 未损坏(1)标记为1
   - 轻微损坏(2)标记为2
   - 中等损坏(3)标记为3
   - 严重损坏(4)标记为4
   - 适用于完整的5类别分类

7. **'damage_only'**
   - 轻微损坏(2)标记为1
   - 中等损坏(3)标记为2
   - 严重损坏(4)标记为3
   - 其他区域标记为0
   - 适用于只关注损坏区域的任务

8. **'severity_weighted'**
   - 轻微损坏(2)标记为0.2
   - 中等损坏(3)标记为0.5
   - 严重损坏(4)标记为1.0
   - 适用于强调严重损坏的任务

## 使用方法

### 1. 数据加载

```python
from train_model import get_multi_class_dataloaders

# 获取多类别数据加载器
train_loader, val_loader, test_loader = get_multi_class_dataloaders(
    data_root="data/combined_dataset",
    batch_size=16,
    num_workers=4,
    damage_level='categorical',  # 推荐用于多类别分类
    show_warnings=False,
    skip_problematic_samples=True
)
```

### 2. 模型创建

```python
from train_model import MultiClassDeepLab

# 创建多类别分类模型
model = MultiClassDeepLab(
    in_channels=3,
    num_classes=5,  # 5个类别
    sim_feat_dim=11
).to(device)
```

### 3. 损失函数

```python
from train_model import MultiClassLoss

# 创建多类别损失函数
criterion = MultiClassLoss(
    alpha=0.4,  # 交叉熵损失权重
    beta=0.3,   # Dice损失权重
    gamma=0.2,  # Focal损失权重
    delta=0.1   # 边界损失权重
).to(device)
```

### 4. 训练

```python
from train_model import train_multi_class_epoch, val_multi_class_epoch

# 训练一个epoch
train_loss, train_acc, train_damage_iou = train_multi_class_epoch(
    model, train_loader, optimizer, criterion, device, epoch, scaler
)

# 验证
val_loss, val_acc, val_damage_iou, val_severe_iou, class_ious = val_multi_class_epoch(
    model, val_loader, criterion, device, scaler
)
```

### 5. 性能评估

```python
from train_model import evaluate_multi_class_performance

# 评估模型性能
performance = evaluate_multi_class_performance(outputs, masks)
print(f"平均IoU: {performance['mean_iou']:.4f}")
print(f"损坏IoU: {performance['damage_iou']:.4f}")
print(f"严重损坏IoU: {performance['severe_damage_iou']:.4f}")
```

## 完整训练示例

运行 `train_multi_class_example.py` 来体验完整的多类别分类训练流程：

```bash
python train_multi_class_example.py
```

## 测试功能

运行 `test_damage_levels.py` 来测试不同的掩码处理方式：

```bash
python test_damage_levels.py
```

## 性能指标

多类别分类模型提供以下性能指标：

1. **平均IoU**: 所有类别的平均IoU
2. **准确率**: 像素级分类准确率
3. **损坏IoU**: 损坏区域（类别2,3,4）的IoU
4. **严重损坏IoU**: 严重损坏（类别4）的IoU
5. **各类别IoU**: 每个类别的单独IoU

## 模型架构

### MultiClassDeepLab

- 基于DeepLabV3+架构
- 支持5个输出类别
- 集成仿真特征融合
- 注意力门控机制
- 预训练编码器（ResNeXt101）

### MultiClassLoss

- 组合损失函数
- 交叉熵损失
- Dice损失
- Focal损失
- 边界损失
- 类别权重平衡

## 数据增强

多类别数据加载器包含以下数据增强：

- 随机水平翻转
- 随机垂直翻转
- 随机旋转（±10度）
- 颜色抖动
- 标准化

## 最佳实践

1. **damage_level选择**:
   - 多类别分类：使用 'categorical'
   - 二分类：使用 'all' 或 'binary'
   - 渐进式学习：使用 'progressive' 或 'severity_weighted'

2. **模型配置**:
   - 批次大小：16-32
   - 学习率：1e-4
   - 优化器：AdamW
   - 调度器：CosineAnnealingLR

3. **损失函数权重**:
   - alpha=0.4 (交叉熵)
   - beta=0.3 (Dice)
   - gamma=0.2 (Focal)
   - delta=0.1 (边界)

4. **训练策略**:
   - 使用混合精度训练
   - 启用梯度缩放
   - 定期保存检查点
   - 监控各类别性能

## 注意事项

1. 确保数据集中包含所有5个类别的样本
2. 注意类别不平衡问题，可能需要调整类别权重
3. 严重损坏样本通常较少，需要特别关注
4. 验证时重点关注损坏区域的IoU指标
5. 保存模型时包含完整的训练状态

## 故障排除

1. **内存不足**: 减小批次大小或使用梯度累积
2. **训练不稳定**: 调整学习率或损失函数权重
3. **类别不平衡**: 调整类别权重或使用数据增强
4. **性能不佳**: 检查数据质量和模型配置

## 扩展功能

1. **自定义damage_level**: 在 `process_xview2_mask` 函数中添加新的处理方式
2. **自定义损失函数**: 继承 `MultiClassLoss` 类并重写相关方法
3. **自定义评估指标**: 在 `evaluate_multi_class_performance` 函数中添加新指标
4. **集成学习**: 使用多个模型进行集成预测

## 文件结构

```
├── train_model.py              # 主要训练代码
├── train_multi_class_example.py # 多类别分类训练示例
├── test_damage_levels.py       # 掩码处理测试
├── 多类别分类使用说明.md        # 本说明文档
└── models/                     # 模型保存目录
    └── best_multi_class_model.pth
``` 