# 分阶段训练与量化功能说明

## 概述

本项目已集成完整的分阶段训练与量化功能，**每个阶段训练20个epoch，阶段完成后自动进行模型量化**，支持无限阶段的持续训练。

## 功能特点

### 1. 分阶段训练
- **阶段1**: epoch 1-20
- **阶段2**: epoch 21-40  
- **阶段3**: epoch 41-60
- **阶段N**: epoch (N-1)*20+1 - N*20
- 每个阶段独立训练和量化

### 2. 智能量化触发
- **阶段内训练**：继续训练当前阶段剩余epoch
- **阶段完成**：自动进行量化，生成阶段专用量化模型
- **阶段间恢复**：从任意epoch恢复，自动计算当前阶段

### 3. 自动量化集成
- 每个阶段完成后自动调用量化脚本
- 量化模型按阶段命名：`quantized_seg_model_stage{N}.pt`
- 无需手动干预，全自动化流程

### 4. 智能模型加载
- 支持检查点格式（checkpoint.pth）
- 支持纯权重格式（best_multimodal_patch_model.pth）
- 自动检测模型格式并正确加载

### 5. 动态量化技术
- 使用PyTorch动态量化
- 量化卷积层和线性层
- 保持模型精度同时减少大小

### 6. 性能测试
- 自动延迟测试（100次推理）
- 内存使用监控
- 性能报告自动保存

## 工作流程

### 训练阶段
1. 自动计算当前训练阶段
2. 训练当前阶段剩余epoch
3. 保存最佳模型权重
4. 保存训练检查点

### 量化阶段（阶段完成后自动触发）
1. **检查阶段完成状态**：
   - 当前阶段所有epoch完成 → 执行量化
   - 当前阶段未完成 → 继续训练
2. 检测最佳模型文件
3. 调用量化脚本
4. 执行动态量化
5. 生成阶段专用量化模型
6. 性能测试和报告
7. 提示下一阶段信息

## 分阶段训练逻辑

```python
# 计算当前阶段
current_stage = (start_epoch - 1) // 20 + 1
stage_start_epoch = (current_stage - 1) * 20 + 1
stage_end_epoch = current_stage * 20

# 检查阶段是否完成
if start_epoch > stage_end_epoch or epoch == stage_end_epoch:
    # 执行量化
    quantize_model()
    # 提示下一阶段
    print(f"下一阶段: 阶段 {current_stage + 1}")
```

## 文件结构

```
项目根目录/
├── train_model.py                    # 训练脚本（包含分阶段训练和量化）
├── inference/
│   └── quantize_model.py            # 量化脚本
├── models/
│   ├── best_multimodal_patch_model.pth  # 最佳模型权重
│   ├── checkpoint.pth               # 训练检查点
│   ├── quantized_seg_model_stage1.pt   # 阶段1量化模型
│   ├── quantized_seg_model_stage2.pt   # 阶段2量化模型
│   ├── quantized_seg_model_stage3.pt   # 阶段3量化模型
│   └── quantization_performance.csv # 性能报告
├── test_quantization.py             # 量化功能测试脚本
├── test_quantization_logic.py       # 量化逻辑测试脚本
└── test_staged_training.py          # 分阶段训练测试脚本
```

## 使用方法

### 1. 开始新训练（阶段1）
```bash
python train_model.py
```
- 从epoch 1开始训练
- 训练epoch 1-20
- 阶段1完成后自动量化

### 2. 从阶段1中间恢复
```bash
python train_model.py
```
- 从中间epoch（如epoch 10）恢复训练
- 继续训练epoch 10-20
- 阶段1完成后自动量化

### 3. 从阶段2开始
```bash
python train_model.py
```
- 从epoch 21开始训练
- 训练epoch 21-40
- 阶段2完成后自动量化

### 4. 从任意阶段恢复
```bash
python train_model.py
```
- 自动计算当前阶段
- 继续训练当前阶段剩余epoch
- 当前阶段完成后自动量化

### 5. 测试分阶段训练逻辑
```bash
python test_staged_training.py
```

## 训练示例

### 示例1：完整阶段1训练
```
当前训练阶段: 1
阶段范围: epoch 1 - 20
Epoch 1/20 - Training: 100%|██████████| 161/161 [00:30<00:00]
Epoch 1/20 - Validation: 100%|██████████| 40/40 [00:05<00:00]
...
Epoch 20/20 - Training: 100%|██████████| 161/161 [00:30<00:00]
Epoch 20/20 - Validation: 100%|██████████| 40/40 [00:05<00:00]

阶段 1 训练完成！开始自动量化模型...
量化模型已保存到 models/quantized_seg_model_stage1.pt

下一阶段: 阶段 2 (epoch 21-40)
重新运行脚本继续下一阶段训练...
```

### 示例2：从阶段2恢复训练
```
发现检查点文件: models/checkpoint.pth, 尝试恢复训练...
恢复训练成功! 将从 epoch 25 开始训练

当前训练阶段: 2
阶段范围: epoch 21 - 40
Epoch 25/40 - Training: 100%|██████████| 161/161 [00:30<00:00]
...
Epoch 40/40 - Training: 100%|██████████| 161/161 [00:30<00:00]

阶段 2 训练完成！开始自动量化模型...
量化模型已保存到 models/quantized_seg_model_stage2.pt

下一阶段: 阶段 3 (epoch 41-60)
重新运行脚本继续下一阶段训练...
```

## 性能指标

基于当前测试结果：

| 指标 | 数值 |
|------|------|
| 平均延迟 | 57.18 ms |
| 最小延迟 | 47.93 ms |
| 最大延迟 | 114.60 ms |
| 标准差 | 9.60 ms |
| 吞吐量 | 17.5 FPS |
| 内存使用 | 3.14 MB |
| 模型大小 | 29.30 MB |

## 量化效果

- **模型压缩**：量化后的模型大小约为原始模型的1/3
- **推理加速**：CPU推理速度提升显著
- **内存优化**：推理时内存使用量减少
- **精度保持**：在可接受的精度损失范围内
- **阶段管理**：每个阶段独立的量化模型

## 注意事项

1. **分阶段管理**：每个阶段独立训练和量化，支持无限阶段
2. **智能恢复**：从任意epoch恢复，自动计算当前阶段
3. **量化命名**：量化模型按阶段命名，便于管理
4. **编码兼容性**：量化脚本已修复Unicode字符编码问题
5. **模型兼容性**：支持多种模型保存格式
6. **错误处理**：完善的异常处理和错误报告
7. **性能监控**：详细的性能指标记录

## 故障排除

### 常见问题

1. **量化脚本执行失败**
   - 检查模型文件是否存在
   - 确认PyTorch版本兼容性
   - 查看错误日志

2. **性能不理想**
   - 检查CPU性能
   - 确认量化引擎设置
   - 调整测试参数

3. **内存不足**
   - 减少batch size
   - 关闭其他程序
   - 使用更小的测试样本

4. **阶段计算错误**
   - 确认epoch编号正确
   - 检查检查点文件完整性
   - 查看训练日志

5. **量化未触发**
   - 确认当前阶段是否完成
   - 检查训练是否真正完成
   - 查看训练日志

## 扩展功能

未来可考虑添加：
- GPU量化支持
- 更多量化算法
- 精度-速度权衡选项
- 批量量化处理
- 量化进度监控
- 阶段间模型对比
- 自动超参数调整

---

**最后更新**：2025-07-27
**版本**：3.0 