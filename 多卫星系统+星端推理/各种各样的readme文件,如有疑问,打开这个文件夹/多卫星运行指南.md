# 多卫星推理系统详细运行指南

## 🚀 快速开始

### 1. 环境准备

首先确保安装了所有必要的依赖：

```bash
# 安装基础依赖
pip install torch torchvision torchaudio
pip install numpy matplotlib pillow
pip install segmentation-models-pytorch
pip install psutil openpyxl

# 检查CUDA支持（可选）
python -c "import torch; print(f'CUDA可用: {torch.cuda.is_available()}')"
```

### 2. 检查模型文件

确保模型文件存在：

```bash
# 检查模型文件
ls -la models/best_multimodal_patch_model.pth

# 如果模型文件不存在，请先训练模型或下载预训练模型
```

### 3. 启动卫星服务器

#### 方法一：单机模拟多卫星（推荐用于测试）

打开三个终端窗口，分别运行：

```bash
# 终端1 - 卫星001
python satellite_inference_server.py --host 127.0.0.1 --port 8080 --satellite_id sat_001 --model models/best_multimodal_patch_model.pth

# 终端2 - 卫星002  
python satellite_inference_server.py --host 127.0.0.1 --port 8081 --satellite_id sat_002 --model models/best_multimodal_patch_model.pth

# 终端3 - 卫星003
python satellite_inference_server.py --host 127.0.0.1 --port 8082 --satellite_id sat_003 --model models/best_multimodal_patch_model.pth
```

#### 方法二：真实多卫星部署

在每个卫星上运行：

```bash
# 卫星001 (IP: 192.168.1.101)
python satellite_inference_server.py --host 0.0.0.0 --port 8080 --satellite_id sat_001

# 卫星002 (IP: 192.168.1.102)
python satellite_inference_server.py --host 0.0.0.0 --port 8080 --satellite_id sat_002

# 卫星003 (IP: 192.168.1.103)
python satellite_inference_server.py --host 0.0.0.0 --port 8080 --satellite_id sat_003
```

### 4. 配置地面控制中心

修改 `multi_satellite_config.json` 文件中的卫星IP地址：

```json
{
  "satellites": {
    "sat_001": {
      "ip": "127.0.0.1",  // 单机测试用
      "port": 8080
    },
    "sat_002": {
      "ip": "127.0.0.1",  // 单机测试用
      "port": 8081
    },
    "sat_003": {
      "ip": "127.0.0.1",  // 单机测试用
      "port": 8082
    }
  }
}
```

### 5. 启动地面控制中心

```bash
python multi_satellite_inference.py
```

## 📋 详细运行步骤

### 步骤1：环境检查

```bash
# 检查Python版本
python --version

# 检查PyTorch安装
python -c "import torch; print(f'PyTorch版本: {torch.__version__}')"

# 检查CUDA支持
python -c "import torch; print(f'CUDA可用: {torch.cuda.is_available()}')"

# 检查依赖包
python -c "import segmentation_models_pytorch as smp; print('smp导入成功')"
```

### 步骤2：模型文件检查

```bash
# 检查模型文件是否存在
ls -la models/

# 如果模型文件不存在，可以：
# 1. 使用现有的模型文件
# 2. 训练新模型
# 3. 下载预训练模型
```

### 步骤3：启动卫星服务器

#### 3.1 单机测试模式

创建启动脚本 `start_satellites.sh`：

```bash
#!/bin/bash

# 启动卫星001
echo "启动卫星001..."
python satellite_inference_server.py --host 127.0.0.1 --port 8080 --satellite_id sat_001 &
SAT1_PID=$!

# 启动卫星002
echo "启动卫星002..."
python satellite_inference_server.py --host 127.0.0.1 --port 8081 --satellite_id sat_002 &
SAT2_PID=$!

# 启动卫星003
echo "启动卫星003..."
python satellite_inference_server.py --host 127.0.0.1 --port 8082 --satellite_id sat_003 &
SAT3_PID=$!

echo "所有卫星已启动"
echo "卫星001 PID: $SAT1_PID"
echo "卫星002 PID: $SAT2_PID"
echo "卫星003 PID: $SAT3_PID"

# 等待用户中断
echo "按 Ctrl+C 停止所有卫星"
trap "kill $SAT1_PID $SAT2_PID $SAT3_PID; echo '所有卫星已停止'; exit" INT
wait
```

运行启动脚本：

```bash
chmod +x start_satellites.sh
./start_satellites.sh
```

#### 3.2 手动启动模式

在三个不同的终端窗口中分别运行：

```bash
# 终端1
python satellite_inference_server.py --host 127.0.0.1 --port 8080 --satellite_id sat_001

# 终端2
python satellite_inference_server.py --host 127.0.0.1 --port 8081 --satellite_id sat_002

# 终端3
python satellite_inference_server.py --host 127.0.0.1 --port 8082 --satellite_id sat_003
```

### 步骤4：配置地面控制中心

#### 4.1 修改配置文件

编辑 `multi_satellite_config.json`：

```json
{
  "satellites": {
    "sat_001": {
      "ip": "127.0.0.1",
      "port": 8080,
      "compute_capacity": 1e12,
      "memory_capacity": 8192,
      "model_version": "v1.0"
    },
    "sat_002": {
      "ip": "127.0.0.1",
      "port": 8081,
      "compute_capacity": 1e12,
      "memory_capacity": 8192,
      "model_version": "v1.0"
    },
    "sat_003": {
      "ip": "127.0.0.1",
      "port": 8082,
      "compute_capacity": 1e12,
      "memory_capacity": 8192,
      "model_version": "v1.0"
    }
  },
  "load_balancing": {
    "strategy": "least_load",
    "health_check_interval": 30,
    "failover_threshold": 3
  },
  "communication": {
    "timeout": 10.0,
    "retry_count": 3,
    "compression": true
  },
  "local_backup": {
    "enabled": true,
    "model_path": "models/best_multimodal_patch_model.pth"
  }
}
```

#### 4.2 启动地面控制中心

```bash
python multi_satellite_inference.py
```

### 步骤5：测试系统

#### 5.1 运行完整测试

```bash
python test_multi_satellite.py
```

#### 5.2 手动测试

```python
# 创建测试脚本 test_manual.py
import numpy as np
from multi_satellite_inference import MultiSatelliteInferenceSystem

# 创建系统
system = MultiSatelliteInferenceSystem("multi_satellite_config.json")

# 发现卫星
system.discover_satellites()

# 生成测试数据
image_data = np.random.rand(3, 256, 256).astype(np.float32)
sim_features = np.random.rand(11).astype(np.float32)

# 提交任务
task_id = system.submit_inference_task(
    image_data=image_data,
    sim_features=sim_features,
    priority=5
)

print(f"提交任务: {task_id}")

# 获取结果
result = system.get_inference_result(task_id, timeout=60.0)

if result:
    print(f"推理成功: {result['status']}")
    print(f"处理时间: {result['processing_time']:.3f}s")
    print(f"卫星ID: {result['satellite_id']}")
else:
    print("推理失败")
```

运行手动测试：

```bash
python test_manual.py
```

## 🔧 故障排除

### 常见问题及解决方案

#### 1. 模型加载失败

**错误信息**：
```
❌ 模型加载失败: [Errno 2] No such file or directory: 'models/best_multimodal_patch_model.pth'
```

**解决方案**：
```bash
# 检查模型文件是否存在
ls -la models/

# 如果不存在，使用其他模型文件
python satellite_inference_server.py --model models/seg_model.pth
```

#### 2. 依赖包缺失

**错误信息**：
```
❌ 缺少依赖: segmentation_models_pytorch
```

**解决方案**：
```bash
pip install segmentation-models-pytorch
```

#### 3. 端口被占用

**错误信息**：
```
OSError: [Errno 98] Address already in use
```

**解决方案**：
```bash
# 查看端口占用
netstat -tulpn | grep 8080

# 杀死占用进程
kill -9 <PID>

# 或使用其他端口
python satellite_inference_server.py --port 8083
```

#### 4. 连接超时

**错误信息**：
```
连接超时
```

**解决方案**：
```bash
# 检查网络连接
ping 127.0.0.1

# 检查防火墙设置
sudo ufw status

# 增加超时时间
# 修改 multi_satellite_config.json 中的 timeout 值
```

#### 5. CUDA内存不足

**错误信息**：
```
CUDA out of memory
```

**解决方案**：
```bash
# 使用CPU模式
export CUDA_VISIBLE_DEVICES=""

# 或减少批处理大小
# 修改代码中的batch_size参数
```

## 📊 监控和调试

### 1. 查看卫星状态

```python
# 获取系统状态
status = system.get_system_status()
print(f"在线卫星数: {status['online_satellites']}")
print(f"队列大小: {status['queue_size']}")

# 查看各卫星详细状态
for sat_id, sat_status in status['satellites'].items():
    print(f"{sat_id}: {sat_status['status']} (负载: {sat_status['load']:.2f})")
```

### 2. 启用详细日志

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 3. 性能监控

```python
# 监控处理时间
import time

start_time = time.time()
result = system.get_inference_result(task_id)
end_time = time.time()

print(f"总耗时: {end_time - start_time:.3f}s")
```

## 🚀 生产环境部署

### 1. 真实卫星部署

在每个卫星上：

```bash
# 1. 上传代码
scp -r . user@satellite_ip:/opt/satellite_inference/

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动服务
python satellite_inference_server.py --host 0.0.0.0 --port 8080

# 4. 设置开机自启
sudo systemctl enable satellite_inference
```

### 2. 地面控制中心部署

```bash
# 1. 配置卫星IP地址
vim multi_satellite_config.json

# 2. 启动控制中心
python multi_satellite_inference.py

# 3. 设置监控
# 配置日志轮转、告警等
```

### 3. 负载均衡配置

```json
{
  "load_balancing": {
    "strategy": "least_load",
    "health_check_interval": 30,
    "failover_threshold": 3,
    "geographic_weight": 0.3,
    "load_weight": 0.4,
    "response_time_weight": 0.3
  }
}
```

## 📈 性能优化

### 1. 模型优化

```python
# 使用量化模型
model = torch.quantization.quantize_dynamic(model, {torch.nn.Linear}, dtype=torch.qint8)

# 使用混合精度
from torch.cuda.amp import autocast
with autocast():
    output = model(input)
```

### 2. 通信优化

```python
# 启用数据压缩
import pickle
import gzip

# 压缩数据
compressed_data = gzip.compress(pickle.dumps(data))
```

### 3. 缓存优化

```python
# 结果缓存
import functools

@functools.lru_cache(maxsize=1000)
def cached_inference(image_hash):
    # 推理逻辑
    pass
```

## 🔒 安全配置

### 1. 通信加密

```python
# 使用SSL/TLS
import ssl

context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)
context.load_cert_chain(certfile="server.crt", keyfile="server.key")
```

### 2. 身份认证

```python
# 添加认证机制
def authenticate_client(client_socket):
    # 实现认证逻辑
    pass
```

### 3. 访问控制

```python
# IP白名单
ALLOWED_IPS = ['192.168.1.101', '192.168.1.102', '192.168.1.103']

def check_ip_whitelist(client_ip):
    return client_ip in ALLOWED_IPS
```

## 📝 总结

通过以上步骤，您可以成功部署和运行多卫星推理系统。系统具备：

✅ **高可用性**: 多卫星冗余确保系统稳定  
✅ **智能调度**: 负载均衡和故障转移  
✅ **实时监控**: 全面的状态监控和告警  
✅ **易于扩展**: 支持动态添加新卫星  
✅ **安全可靠**: 完整的错误处理和恢复机制  

如果在运行过程中遇到任何问题，请参考故障排除部分或查看详细的错误日志。 